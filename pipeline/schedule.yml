
schedule:leopard_string_extraction:
  stage: schedule
  image: $CI_REGISTRY/contextlogic/strings:79bee9cf19c07bee8f248caf61c1ccd8e4d66a23
  script:
    - export LEOPARD_HOME=$(pwd)
    - START_TIME=$SECONDS
    - /go/bin/strings extract $LEOPARD_HOME --smartling-api-secrets="${SMARTLING_API_SECRETS}"
    - echo 'leopard_string_extraction_runtime_seconds' $((SECONDS-START_TIME)) | curl --data-binary @- http://pushgateway.infra.wish.com:9091/metrics/job/gitlab
    - echo 'leopard_string_extraction_last_success_timestamp' $(date -u +%s) | curl --data-binary @- http://pushgateway.infra.wish.com:9091/metrics/job/gitlab
  rules:
    - if: '$SCHEDULE == "leopard_string_extraction" && $CI_PIPELINE_SOURCE == "schedule"'
      when: on_success

schedule:leopard_string_build:
  stage: schedule
  image: $CI_REGISTRY/contextlogic/strings:79bee9cf19c07bee8f248caf61c1ccd8e4d66a23
  script:
    - export LEOPARD_HOME=$(pwd)
    - mkdir /root/.ssh/ && touch /root/.ssh/id_rsa
    - echo $GITHUB_DEPLOY_KEY | base64 -di > /root/.ssh/id_rsa
    - git config --global user.email "gitlab@wish.com"
    - git config --global user.name "Gitlab Bot"
    - git remote set-url origin git@github.com:ContextLogic/leopard.git
    - chmod 600 /root/.ssh/id_rsa
    - ssh-keyscan -t rsa github.com >> /root/.ssh/known_hosts
    - sh $LEOPARD_HOME/localization_sync.sh # includes pushing prometheus metrics
  rules:
    - if: '$SCHEDULE == "leopard_string_build" && $CI_PIPELINE_SOURCE == "schedule"'
      when: on_success
