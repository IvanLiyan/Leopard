stages:
  - schedule
  - install
  - test
  - deploy

install dependencies:
  stage: install
  image: registry-gitlab.i.wish.com/contextlogic/leopard/node:18
  script:
    - yarn install --frozen-lockfile
  artifacts:
    paths:
      - node_modules/

test:
  stage: test
  image: registry-gitlab.i.wish.com/contextlogic/leopard/node:18
  script:
    - yarn test-ci
  dependencies:
    - install dependencies

lint:
  stage: test
  image: registry-gitlab.i.wish.com/contextlogic/leopard/node:18
  script:
    - yarn lint
    - yarn graphql-codegen --overwrite --verbose
    - git diff --no-patch --exit-code
  dependencies:
    - install dependencies

build staging:
  stage: test
  image: registry-gitlab.i.wish.com/contextlogic/leopard/node:18
  script:
    # we want the `development` configs on staging, even though we are optimizing the build for prod
    - cp .env.development .env.production
    - yarn build
  artifacts:
    when: always
    paths:
      - out
  dependencies:
    - install dependencies

build prod:
  stage: test
  image: registry-gitlab.i.wish.com/contextlogic/leopard/node:18
  script:
    - yarn build
  artifacts:
    when: always
    paths:
      - out
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  dependencies:
    - install dependencies

deploy staging:
  stage: deploy
  image: registry-gitlab.i.wish.com/contextlogic/leopard/aws-base-with-brotli:latest
  script:
    - sh scripts/deploy.sh -s=leopard-staging
  environment:
    name: staging
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: on_success
    - when: manual
      allow_failure: true
  tags: [leopard-staging]
  dependencies:
    - build staging

deploy prod:
  stage: deploy
  image: registry-gitlab.i.wish.com/contextlogic/leopard/aws-base-with-brotli:latest
  script:
    - sh scripts/deploy.sh -s=leopard-production
  environment:
    name: production
  when: manual
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  tags: [leopard]
  dependencies:
    - build prod

extract strings for translation:
  stage: deploy
  image: registry-gitlab.i.wish.com/contextlogic/strings:latest_v2
  script:
    - /go/bin/strings extract $(pwd) --client-id="${XTM_CLIENT_ID}" --client-secret="${XTM_CLIENT_SECRET}"
  when: on_success
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  tags: [leopard]
#
# temp disabling lighthouse so we can remove docker - will re-write at a later date
# include:
#   - project: "contextlogic/includes"
#     ref: master
#     file: "/templates/job-build-and-tag/ecr-commit.yml"
#   - local: "pipeline/schedule.yml"
#   - local: "pipeline/test.yml"
